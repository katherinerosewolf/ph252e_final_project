---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Katie's ltmle code

```{r}

# load libraries
library(tidyverse)
library(here)
library(pander)
library(tikzDevice)
library(ltmle)

```


```{r chen code}

here()

# run Chen's script to make the imputed dataset
source(here::here("scripts", 
                  "01-get-data.R"))

# save file to disk
save(frm.wide, 
     file = here("data", 
                 "frm_wide.rdata"))

```


```{r looking at the data}

# load imputed dataset
load(file = here("data", 
                 "frm_wide.rdata"))

# check number of rows
nrow(frm.wide)

# check if we have NAs
sum(is.na(frm.wide))




```


```{r ltmle package . . . running targeted mle}

# check no NAS
frm_wide_working <- frm.wide

# reorder data
frm_time_order <- frm.wide %>% 
  select("sex", 
         "educ", 
         "age_1", 
         "cigpday_1", 
         "bmi_1", 
         "chd_1", 
         "hyperten_1", 
         "tol_chol_1", 
         "stroke_1", 
         "age_2", 
         "cigpday_2", 
         "bmi_2", 
         "chd_2", 
         "hyperten_2", 
         "tol_chol_2", 
         "stroke_2", 
         "age_3", 
         "cigpday_3", 
         "bmi_3", 
         "chd_3", 
         "hyperten_3", 
         "tol_chol_3", 
         "stroke_3")

# prevalent stroke?
# cens variables?

# set n equal to number of rows
n = nrow(frm.wide)

# initialize regimes 
# dim n 
# num Anodes = 3 (?)
# num CF regimes = 8 (? 2 x 2 x 2)
regimes <- list(function(row) c(1,1,1), 
                function(row) c(1,1,0), 
                function(row) c(1,0,1), 
                function(row) c(1,0,0), 
                function(row) c(0,1,1), 
                function(row) c(0,1,0), 
                function(row) c(0,0,1), 
                function(row) c(0,0,0))

# make summary measures (number of regimes, number of Anodes, time)
summary.measures <- array(dim = c(8, 1, 3))

dimnames(summary.measures)[[2]] <- c("sum_chol")

summary.measures[, , 1] <- cbind(0:3, rep(1, 8))
summary.measures[, , 2] <- cbind(0:3, rep(2, 8))
summary.measures[, , 3] <- cbind(0:3, rep(3, 8))

sums <- 

  dimnames()

results_first_try <- ltmle(data = frm_time_order, 
                           Anodes = c("totchol_1", 
                                      "totchol_2", 
                                      "totchol_3"), 
                           Lnodes = c("sex", 
                                      "educ", 
                                      "age_1", 
                                      "cigpday_1", 
                                      "bmi_1", 
                                      "chd_1", 
                                      "hyperten_1", 
                                      "age_2", 
                                      "cigpday_2", 
                                      "bmi_2", 
                                      "chd_2", 
                                      "hyperten_2", 
                                      "age_3", 
                                      "cigpday_3", 
                                      "bmi_3", 
                                      "chd_3", 
                                      "hyperten_3"), 
                           Cnodes = NA, 
                           Ynodes = c("stroke_1", 
                                      "stroke_2", 
                                      "stroke_3"), 
                           survivalOutcome = TRUE)





# # summary.measures
# "Y ~ time + pmax(time - switch.time,
# 0)"
# 
# Lnodes <- c("CD4_1", "CD4_2")
# Anodes <- c("A0", "A1", "A2")
# Ynodes <- c("Y1", "Y2", "Y3")
# D <- list(function(row) c(1, 1, 1), function(row) c(0, 1, 1),
# + function(row) c(0, 0, 1), function(row) c(0, 0, 0))
# summary.measures <- array(dim = c(4, 2, 3))
# dimnames(summary.measures)[[2]] <- c("switch.time", "time")
# summary.measures[, , 1] <- cbind(0:3, rep(1, 4))
# summary.measures[, , 2] <- cbind(0:3, rep(2, 4))
# summary.measures[, , 3] <- cbind(0:3, rep(3, 4))


ltmle(survivalOutcome = TRUE)


```
